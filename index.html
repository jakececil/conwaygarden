<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conway's Garden ‚Äî Interactive</title>
  <style>
    :root{
      --ui-bg:#0b0b0f; /* page bg */
      --panel:#11131a; /* sidebar bg */
      --panel-2:#0c0e14; /* sheet bg (mobile) */
      --ink:#d8e1ff; /* text */
      --ink-dim:#93a1c6; /* subtext */
      --accent:#7cf0ff;
      --accent-2:#ff86d8;
      --good:#8cff9c;
      --bad:#ff8c8c;
      --border:#1e2230;
      --shadow:#00000080;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; background:#000; color:var(--ink); font:14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    #wrap{position:fixed; inset:0; display:grid; grid-template-columns: 300px 1fr;}
    /* Sidebar (desktop) */
    #sidebar{
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border-right:1px solid var(--border);
      padding:14px 12px 18px; overflow:auto; box-shadow:2px 0 12px var(--shadow);
    }
    #title{display:flex; gap:8px; align-items:center; font-weight:700; letter-spacing:.3px; margin-bottom:6px}
    #title .dot{width:10px;height:10px;border-radius:50%; background:conic-gradient(from 0deg, #77f, #7ff, #7f7, #ff7, #f77, #f7f, #77f);}    
    #subtitle{color:var(--ink-dim); font-size:12px; margin-bottom:12px}
    fieldset{border:1px solid var(--border); padding:10px; border-radius:12px; margin:8px 0;}
    legend{color:var(--accent); font-size:12px; padding:0 6px;}
    label{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin:8px 0;}
    input[type=range]{width:160px}
    input[type=number]{width:64px; background:#0a0c12; border:1px solid var(--border); color:var(--ink); border-radius:8px; padding:6px}
    select{width:100%; background:#0a0c12; border:1px solid var(--border); color:var(--ink); border-radius:8px; padding:6px}
    button{appearance:none; background:#121624; border:1px solid var(--border); color:var(--ink); border-radius:12px; padding:8px 10px; cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1a2036,#151a2b); border-color:#2a3350;}
    button:hover{filter:brightness(1.05)}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .note{font-size:12px; color:var(--ink-dim)}

    /* Canvas fits remaining grid col */
    #stage-wrap{position:relative;}
    canvas#stage{position:absolute; inset:0; width:100%; height:100%; image-rendering: pixelated;}
    #hud{position:absolute; right:8px; bottom:6px; color:#cfe3ff; font-size:12px; background:#0008; padding:6px 8px; border-radius:10px; border:1px solid #234;}

    /* Mobile: collapse sidebar, show fab control button */
    @media (max-width: 900px){
      #wrap{grid-template-columns: 1fr;}
      #sidebar{display:none}
      #mobile-toggle{display:flex}
      #sheet{display:block}
    }

    /* Mobile controls */
    #mobile-toggle{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:14px; display:none; gap:8px; align-items:center;
      background:linear-gradient(180deg, #13182a, #0c1020);
      border:1px solid #263153; color:var(--ink); border-radius:999px; padding:10px 14px; z-index:20; box-shadow:0 12px 24px var(--shadow);
    }
    #sheet{display:none}
    #sheet[open]{
      position:fixed; inset:auto 0 0 0; height:72vh; z-index:30; margin:0; padding:0; border:none; background:transparent;
    }
    #sheet::backdrop{background:#000a}
    .sheet-panel{
      height:100%; background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border-top-left-radius:16px; border-top-right-radius:16px; border-top:1px solid var(--border);
      padding:10px 10px 18px; overflow:auto; box-shadow:0 -12px 30px var(--shadow);
    }
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; background:#0c1122; border:1px solid #23304d; font-size:12px;}
  </style>
</head>
<body>
  <div id="wrap">
    <aside id="sidebar">
      <div id="title"><div class="dot"></div> Conway's Garden</div>
      <div id="subtitle">Healthy, always‚Äëmoving defaults: generous food, diffusion, and optional auto‚Äëgrowth pulses. Click/drag or touch to seed life or paint food.</div>

      <fieldset>
        <legend>Simulation</legend>
        <label>Play / Pause <button id="btnToggle" class="primary">‚ñ∂Ô∏è Play</button></label>
        <div class="row">
          <button id="btnStep">‚è≠Ô∏è Step</button>
          <button id="btnRandom">üé≤ Randomize Critters</button>
          <button id="btnFoodSeed">üåà Re‚Äëseed Food</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="btnClear">üßπ Clear Critters</button>
          <button id="btnClearFood">üßΩ Clear Food</button>
          <button id="btnReset">‚Ü©Ô∏é Reset Defaults</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Timing & Scale</legend>
        <label>Speed (steps/sec)
          <input id="speed" type="range" min="1" max="60" value="24" />
        </label>
        <label>Pixel scale (smaller = denser)
          <input id="cellSize" type="range" min="2" max="10" value="4" />
        </label>
      </fieldset>

      <fieldset>
        <legend>Classic Life Rules</legend>
        <label>Survive: min neighbors
          <input id="surviveMin" type="range" min="1" max="5" value="2" />
        </label>
        <label>Survive: max neighbors
          <input id="surviveMax" type="range" min="2" max="8" value="3" />
        </label>
        <label>Birth: neighbors ==
          <input id="birthEq" type="range" min="2" max="6" value="3" />
        </label>
      </fieldset>

      <fieldset>
        <legend>Food Field</legend>
        <label>Food needed to survive
          <input id="foodNeed" type="range" min="0" max="100" value="4" />
        </label>
        <label>Food needed to birth
          <input id="foodBirth" type="range" min="0" max="100" value="10" />
        </label>
        <label>Food consumed per alive
          <input id="foodEat" type="range" min="0" max="100" value="10" />
        </label>
        <label>Diffusion (spread)
          <input id="diffuse" type="range" min="0" max="100" value="18" />
        </label>
        <label>Decay (fade)
          <input id="decay" type="range" min="0" max="50" value="0" />
        </label>
      </fieldset>

      <fieldset>
        <legend>Auto Food Growth</legend>
        <label>Enable growth
          <input id="growthOn" type="checkbox" checked />
        </label>
        <label>Growth per second
          <input id="growthRate" type="range" min="0" max="100" value="18" />
        </label>
        <label>Pulse frequency (Hz)
          <input id="pulseHz" type="range" min="0" max="2" step="0.01" value="0.40" />
        </label>
        <label>Pulse strength
          <input id="pulseAmt" type="range" min="0" max="100" value="25" />
        </label>
      </fieldset>

      <fieldset>
        <legend>Brush & Palette</legend>
        <label>Brush size (px)
          <input id="brush" type="range" min="1" max="32" value="10" />
        </label>
        <div class="row" style="margin:6px 0 4px">
          <span class="chip"><input type="radio" name="mode" id="modeLife" checked> Life</span>
          <span class="chip"><input type="radio" name="mode" id="modeEraseLife"> Erase Life</span>
          <span class="chip"><input type="radio" name="mode" id="modeFood"> Paint Food</span>
          <span class="chip"><input type="radio" name="mode" id="modeEraseFood"> Erase Food</span>
        </div>
        <label>Color palette
          <select id="palette">
            <option value="rainbow">Rainbow Age (vivid)</option>
            <option value="biolume">Bioluminescent</option>
            <option value="ember">Embers & Ash</option>
          </select>
        </label>
        <div class="note">Tips: Space = pause. R = random critters. C = clear critters. Drag to draw. Pinch‚Äëzoom your browser to change apparent pixel size.</div>
      </fieldset>

      <div class="note">Made for Chrome on macOS. Single‚Äëfile, GitHub‚Äëready.</div>
    </aside>

    <main id="stage-wrap">
      <canvas id="stage"></canvas>
      <div id="hud">‚Ä¶</div>
    </main>
  </div>

  <!-- Mobile FAB and bottom sheet -->
  <button id="mobile-toggle">‚öôÔ∏è Controls</button>
  <dialog id="sheet">
    <div class="sheet-panel">
      <div id="sheetContent"><!-- controls will be cloned here --></div>
    </div>
  </dialog>

  <script>
    // --- Utilities ---
    const clamp = (v, lo, hi) => v < lo ? lo : (v > hi ? hi : v);
    function hsvToRgb(h, s, v){
      h = (h%360+360)%360; s=clamp(s,0,1); v=clamp(v,0,1);
      const c=v*s; const x=c*(1-Math.abs((h/60)%2-1)); const m=v-c;
      let r=0,g=0,b=0; const i=Math.floor(h/60);
      if(i===0){r=c;g=x;b=0}else if(i===1){r=x;g=c;b=0}
      else if(i===2){r=0;g=c;b=x}else if(i===3){r=0;g=x;b=c}
      else if(i===4){r=x;g=0;b=c}else {r=c;g=0;b=x}
      return [(r+m)*255,(g+m)*255,(b+m)*255];
    }
    function rand(){return Math.random()}
    function noise2D(x,y){return fract(Math.sin(x*127.1+y*311.7)*43758.5453)}
    function fract(n){return n-Math.floor(n)}

    // --- DOM ---
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d', {alpha:false});
    const hud = document.getElementById('hud');
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobile-toggle');
    const sheet = document.getElementById('sheet');
    const sheetContent = document.getElementById('sheetContent');

    // Controls
    const ctl = {
      speed: document.getElementById('speed'),
      cellSize: document.getElementById('cellSize'),
      surviveMin: document.getElementById('surviveMin'),
      surviveMax: document.getElementById('surviveMax'),
      birthEq: document.getElementById('birthEq'),
      foodNeed: document.getElementById('foodNeed'),
      foodBirth: document.getElementById('foodBirth'),
      foodEat: document.getElementById('foodEat'),
      diffuse: document.getElementById('diffuse'),
      decay: document.getElementById('decay'),
      growthOn: document.getElementById('growthOn'),
      growthRate: document.getElementById('growthRate'),
      pulseHz: document.getElementById('pulseHz'),
      pulseAmt: document.getElementById('pulseAmt'),
      brush: document.getElementById('brush'),
      palette: document.getElementById('palette'),
      modeLife: document.getElementById('modeLife'),
      modeEraseLife: document.getElementById('modeEraseLife'),
      modeFood: document.getElementById('modeFood'),
      modeEraseFood: document.getElementById('modeEraseFood'),
      btnToggle: document.getElementById('btnToggle'),
      btnStep: document.getElementById('btnStep'),
      btnRandom: document.getElementById('btnRandom'),
      btnFoodSeed: document.getElementById('btnFoodSeed'),
      btnClear: document.getElementById('btnClear'),
      btnClearFood: document.getElementById('btnClearFood'),
      btnReset: document.getElementById('btnReset'),
    };

    // --- Simulation State ---
    let gridW=0, gridH=0, pixels=null; // ImageData
    let lifeA, lifeB, ageA, ageB; // Uint8/Uint16 double buffers
    let foodA, foodB; // Float32
    let running=false, simTime=0, lastT=performance.now();
    let frames=0, fps=0, lastFpsT=performance.now();
    let pulseTimer=0; // for auto pulses

    // Parameters (normalized where helpful)
    const P = {
      surviveMin:2, surviveMax:3, birthEq:3,
      foodNeed:0.04, foodBirth:0.10, foodEat:0.10,
      diffuse:0.18, decay:0.0005,
      cellSize:4, speed:24,
      palette:'rainbow',
      growthOn:true, growthPerSec:0.045, pulseHz:0.40, pulseAmt:0.25
    };

    function applyControlsToParams(){
      P.speed = +ctl.speed.value;
      const newCell = +ctl.cellSize.value;
      if(newCell !== P.cellSize){ P.cellSize = newCell; resize(); }
      P.surviveMin = +ctl.surviveMin.value;
      P.surviveMax = +ctl.surviveMax.value;
      P.birthEq = +ctl.birthEq.value;
      P.foodNeed = +ctl.foodNeed.value/100;
      P.foodBirth = +ctl.foodBirth.value/100;
      P.foodEat = +ctl.foodEat.value/100;
      P.diffuse = +ctl.diffuse.value/100;
      P.decay = +ctl.decay.value/1000; // fine grain
      P.palette = ctl.palette.value;
      P.growthOn = !!ctl.growthOn.checked;
      P.growthPerSec = (+ctl.growthRate.value/100) * 0.25; // up to +0.25 per second
      P.pulseHz = +ctl.pulseHz.value;
      P.pulseAmt = (+ctl.pulseAmt.value/100) * 0.5; // up to +0.5 per hit
    }

    // --- Resize / Grid setup ---
    function resize(){
      const padLeft = window.innerWidth>900 ? 300 : 0;
      const W = window.innerWidth - padLeft;
      const H = window.innerHeight;
      gridW = Math.floor(W / P.cellSize);
      gridH = Math.floor(H / P.cellSize);

      canvas.width = gridW; canvas.height = gridH;
      ctx.imageSmoothingEnabled = false;
      pixels = ctx.createImageData(gridW, gridH);

      // Allocate new buffers keeping as much old content as possible
      const N = gridW*gridH;
      const oldLife = lifeA; const oldAge = ageA; const oldFood = foodA;
      lifeA = new Uint8Array(N); lifeB = new Uint8Array(N);
      ageA = new Uint16Array(N); ageB = new Uint16Array(N);
      foodA = new Float32Array(N); foodB = new Float32Array(N);

      if(oldLife && oldAge && oldFood){
        const oldW = canvas._oldW||0, oldH = canvas._oldH||0;
        const copyW = Math.min(oldW, gridW), copyH = Math.min(oldH, gridH);
        for(let y=0;y<copyH;y++){
          for(let x=0;x<copyW;x++){
            const ni = y*gridW + x;
            const oi = y*oldW + x;
            lifeA[ni] = oldLife[oi];
            ageA[ni]  = oldAge[oi];
            foodA[ni] = oldFood[oi];
          }
        }
      } else {
        randomizeLife(0.24);
        seedFoodField();
      }
      canvas._oldW = gridW; canvas._oldH = gridH;
      render();
    }

    function index(x,y){ return y*gridW + x }

    // --- Seeding ---
    function randomizeLife(p=0.24){
      for(let i=0;i<lifeA.length;i++){
        const alive = (Math.random() < p)?1:0;
        lifeA[i]=alive; ageA[i]= alive? (1+Math.floor(rand()*20)) : 0;
      }
    }
    function seedFoodField(){
      for(let y=0;y<gridH;y++){
        for(let x=0;x<gridW;x++){
          // Multi-octave simple hash noise for colorful base
          const n = 0.55*noise2D(x*0.11, y*0.07) + 0.27*noise2D(x*0.041, y*0.052) + 0.18*noise2D(x*0.013, y*0.017);
          foodA[index(x,y)] = 0.45 + 0.55*n; // richer baseline 0.45..1.0
        }
      }
    }
    function clearLife(){ lifeA.fill(0); ageA.fill(0); }
    function clearFood(){ foodA.fill(0); }

    // --- Auto growth helpers ---
    function growFood(dt){
      if(!P.growthOn) return;
      const add = P.growthPerSec * dt;
      if(add<=0) return;
      for(let i=0;i<foodA.length;i++) foodA[i] = clamp(foodA[i] + add, 0, 1);
    }
    function pulseFood(){
      if(P.pulseHz<=0 || P.pulseAmt<=0) return;
      // sprinkle small random hits across the map (about 0.25% of cells)
      const N = gridW*gridH; const hits = Math.max(8, Math.floor(N*0.0025));
      for(let k=0;k<hits;k++){
        const i = (Math.random()*N)|0;
        foodA[i] = clamp(foodA[i] + (P.pulseAmt * (0.6 + 0.8*Math.random())), 0, 1);
      }
    }

    // --- Step Simulation ---
    function stepLife(){
      // Food diffusion first (semi-implicit)
      const W=gridW, H=gridH; const fa=foodA, fb=foodB;
      const d = P.diffuse, k = 1 - P.decay;
      for(let y=0;y<H;y++){
        const ym = (y-1+H)%H, yp=(y+1)%H;
        for(let x=0;x<W;x++){
          const xm = (x-1+W)%W, xp=(x+1)%W;
          const i = y*W+x;
          const n00 = fa[i];
          const n1 = fa[ym*W + x], n2 = fa[yp*W + x], n3 = fa[y*W + xm], n4 = fa[y*W + xp];
          const avg = (n1+n2+n3+n4)*0.25;
          fb[i] = clamp((n00*(1-d) + avg*d) * k, 0, 1);
        }
      }
      [foodA, foodB] = [foodB, foodA];

      // Life using classic Moore neighbors + food gating
      const la=lifeA, lb=lifeB, aa=ageA, ab=ageB, f=foodA;
      const smin=P.surviveMin|0, smax=P.surviveMax|0, beq=P.birthEq|0;
      const needS=P.foodNeed, needB=P.foodBirth, eat=P.foodEat;
      for(let y=0;y<H;y++){
        const ym=(y-1+H)%H, yp=(y+1)%H;
        for(let x=0;x<W;x++){
          const xm=(x-1+W)%W, xp=(x+1)%W;
          const i=y*W+x;
          const n = la[ym*W+xm]+la[ym*W+x]+la[ym*W+xp]+
                    la[y *W+xm]                +la[y *W+xp]+
                    la[yp*W+xm]+la[yp*W+x]+la[yp*W+xp];
          const alive = la[i];
          let foodHere = f[i];
          if(alive){
            if(n>=smin && n<=smax && foodHere>needS){
              lb[i]=1; ab[i]=aa[i]+1;
              f[i]=clamp(foodHere - eat*0.4, 0, 1); // gentle consumption
            } else { lb[i]=0; ab[i]=0; }
          } else {
            if(n===beq && foodHere>needB){
              lb[i]=1; ab[i]=1; f[i]=clamp(foodHere - eat*0.8, 0, 1);
            } else { lb[i]=0; ab[i]=0; }
          }
        }
      }
      [lifeA, lifeB] = [lifeB, lifeA];
      [ageA, ageB]   = [ageB, ageA];
    }

    // --- Rendering ---
    function render(){
      const data = pixels.data; const la=lifeA, aa=ageA, f=foodA; const W=gridW, H=gridH;
      let p=0;
      for(let i=0;i<W*H;i++){
        if(la[i]){
          const age = aa[i];
          let r=0,g=0,b=0;
          if(P.palette==='biolume'){
            const h=(age*11 + (i%W))*0.9 % 360; const [R,G,B]=hsvToRgb(h,1,1);
            r=R; g=G; b=B;
          } else if(P.palette==='ember'){
            const v = 0.6 + 0.4*Math.tanh(age*0.05);
            const [R,G,B] = hsvToRgb(24 + (age%40), 0.95, v);
            r=R; g=G; b=B;
          } else {
            const h = (age*9 + (i%W)*0.4 + Math.floor(i/W)*0.6) % 360;
            const [R,G,B]=hsvToRgb(h,0.95,1.0); r=R; g=G; b=B;
          }
          data[p++]=r; data[p++]=g; data[p++]=b; data[p++]=255;
        } else {
          const fv = f[i];
          let r=0,g=0,b=0;
          if(P.palette==='ember'){
            const [R,G,B] = hsvToRgb(220 - 120*fv, 0.25+0.55*fv, 0.05+0.35*fv);
            r=R; g=G; b=B;
          } else if(P.palette==='biolume'){
            const [R,G,B] = hsvToRgb(180+120*fv, 0.8, 0.08+0.45*fv);
            r=R; g=G; b=B;
          } else {
            const [R,G,B]=hsvToRgb(240*fv, 0.6, 0.1+0.45*fv);
            r=R; g=G; b=B;
          }
          data[p++]=r; data[p++]=g; data[p++]=b; data[p++]=255;
        }
      }
      ctx.putImageData(pixels, 0, 0);
    }

    // --- Animation Loop ---
    function tick(now){
      const dt = (now - lastT)/1000; lastT = now;
      simTime += dt;
      const stepTime = 1/Math.max(1, P.speed);
      while(simTime >= stepTime){
        stepLife();
        simTime -= stepTime;
      }
      // continuous food growth + pulses independent of discrete steps
      growFood(dt);
      pulseTimer += dt;
      if(P.pulseHz>0){
        const interval = 1/P.pulseHz;
        while(pulseTimer >= interval){ pulseFood(); pulseTimer -= interval; }
      }

      render();
      frames++;
      if(now - lastFpsT > 500){ fps = Math.round( frames * 1000 / (now - lastFpsT) ); frames=0; lastFpsT = now; }
      hud.textContent = `FPS ${fps} | ${gridW}√ó${gridH} | Pixel ${P.cellSize}px | Palette ${P.palette}`;
      if(running) requestAnimationFrame(tick);
    }

    function play(){ if(!running){ running=true; ctl.btnToggle.textContent='‚è∏Ô∏è Pause'; requestAnimationFrame(tick);} }
    function pause(){ running=false; ctl.btnToggle.textContent='‚ñ∂Ô∏è Play'; }
    function stepOnce(){ if(!running){ stepLife(); render(); }}

    // --- Drawing / Interaction ---
    let drawing=false; let drawMode='life';
    function currentBrush(){ return +ctl.brush.value }
    function setDrawMode(){
      if(ctl.modeEraseLife.checked) drawMode='eraseLife';
      else if(ctl.modeFood.checked) drawMode='food';
      else if(ctl.modeEraseFood.checked) drawMode='eraseFood';
      else drawMode='life';
    }
    function paintAt(clientX, clientY){
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((clientX - rect.left) / rect.width * gridW);
      const y = Math.floor((clientY - rect.top) / rect.height * gridH);
      const r = currentBrush();
      const r2=r*r;
      for(let dy=-r; dy<=r; dy++){
        for(let dx=-r; dx<=r; dx++){
          if(dx*dx+dy*dy>r2) continue;
          const xi=(x+dx+gridW)%gridW, yi=(y+dy+gridH)%gridH;
          const i=index(xi,yi);
          if(drawMode==='life'){ lifeA[i]=1; ageA[i]=1+Math.floor(rand()*10); }
          else if(drawMode==='eraseLife'){ lifeA[i]=0; ageA[i]=0; }
          else if(drawMode==='food'){ foodA[i]=clamp(foodA[i]+0.2,0,1); }
          else if(drawMode==='eraseFood'){ foodA[i]=clamp(foodA[i]-0.25,0,1); }
        }
      }
    }

    function attachPointerEvents(){
      const start = (e)=>{ drawing=true; setDrawMode();
        if(e.pointerType==='pen'||e.pointerType==='touch') canvas.setPointerCapture(e.pointerId);
        paintAt(e.clientX,e.clientY);
      };
      const move = (e)=>{ if(!drawing) return; paintAt(e.clientX,e.clientY); };
      const end = (e)=>{ drawing=false; try{canvas.releasePointerCapture(e.pointerId)}catch(_){} };
      canvas.addEventListener('pointerdown', start, {passive:true});
      window.addEventListener('pointermove', move, {passive:true});
      window.addEventListener('pointerup', end, {passive:true});
      window.addEventListener('pointercancel', end, {passive:true});
    }

    // --- Keyboard Shortcuts ---
    window.addEventListener('keydown', (e)=>{
      if(e.code==='Space'){ e.preventDefault(); running?pause():play(); }
      else if(e.key==='r' || e.key==='R'){ randomizeLife(); }
      else if(e.key==='c' || e.key==='C'){ clearLife(); }
    });

    // --- Control Wiring ---
    Object.values(ctl).forEach(el=>{
      if(!el || !(el instanceof HTMLElement)) return;
      const type = (el.getAttribute('type')||'').toLowerCase();
      if(type==='range' || el.tagName==='SELECT' || type==='checkbox'){
        el.addEventListener('input', ()=>applyControlsToParams());
      }
    });
    ctl.btnToggle.addEventListener('click', ()=> running?pause():play());
    ctl.btnStep.addEventListener('click', stepOnce);
    ctl.btnRandom.addEventListener('click', ()=>{ randomizeLife(); });
    ctl.btnFoodSeed.addEventListener('click', ()=>{ seedFoodField(); });
    ctl.btnClear.addEventListener('click', ()=>{ clearLife(); });
    ctl.btnClearFood.addEventListener('click', ()=>{ clearFood(); });
    ctl.btnReset.addEventListener('click', ()=>{
      ctl.speed.value=24; ctl.cellSize.value=4; ctl.surviveMin.value=2; ctl.surviveMax.value=3; ctl.birthEq.value=3;
      ctl.foodNeed.value=4; ctl.foodBirth.value=10; ctl.foodEat.value=10; ctl.diffuse.value=18; ctl.decay.value=0;
      ctl.growthOn.checked=true; ctl.growthRate.value=18; ctl.pulseHz.value=0.40; ctl.pulseAmt.value=25;
      ctl.brush.value=10; ctl.palette.value='rainbow'; ctl.modeLife.checked=true; applyControlsToParams();
    });

    // --- Mobile sheet: clone controls from sidebar ---
    function buildMobileSheet(){
      const clone = sidebar.cloneNode(true);
      clone.id=''; sheetContent.innerHTML='';
      clone.querySelectorAll('fieldset').forEach(fs=> sheetContent.appendChild(fs));
      ['speed','cellSize','surviveMin','surviveMax','birthEq','foodNeed','foodBirth','foodEat','diffuse','decay','growthOn','growthRate','pulseHz','pulseAmt','brush','palette','modeLife','modeEraseLife','modeFood','modeEraseFood','btnToggle','btnStep','btnRandom','btnFoodSeed','btnClear','btnClearFood','btnReset'].forEach(id=>{
        ctl[id] = document.getElementById(id) || sheetContent.querySelector('#'+id) || sheetContent.querySelector('[id="'+id+'"]');
      });
    }

    mobileToggle.addEventListener('click', ()=>{ if(!sheet.open){ sheet.showModal(); } });
    sheet.addEventListener('click', (e)=>{ if(e.target===sheet) sheet.close(); });

    // --- Init ---
    attachPointerEvents();
    buildMobileSheet();
    applyControlsToParams();
    window.addEventListener('resize', resize);
    resize();

    // Initial seed for healthy motion
    randomizeLife(0.24);
    seedFoodField();
    play();
  </script>
</body>
</html>
